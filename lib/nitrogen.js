"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),_elementsNitrogenToolbarElement=require("./elements/nitrogen-toolbar-element"),_elementsNitrogenToolbarElement2=_interopRequireDefault(_elementsNitrogenToolbarElement),_atom=require("atom"),_path=require("path"),_path2=_interopRequireDefault(_path),_remote=require("remote"),_remote2=_interopRequireDefault(_remote),_welcome=require("./welcome"),_welcome2=_interopRequireDefault(_welcome),_login=require("./login"),_login2=_interopRequireDefault(_login),_containerSettings=require("./container-settings"),_containerSettings2=_interopRequireDefault(_containerSettings),_shell=require("./shell"),_shell2=_interopRequireDefault(_shell),_webview=require("./webview"),_webview2=_interopRequireDefault(_webview),_renameWatcher=require("./rename-watcher"),_renameWatcher2=_interopRequireDefault(_renameWatcher),_feedback=require("./feedback"),_feedback2=_interopRequireDefault(_feedback),_storesNsyncStore=require("./stores/nsync-store"),_storesNsyncStore2=_interopRequireDefault(_storesNsyncStore),_storesTokenStore=require("./stores/token-store"),_storesTokenStore2=_interopRequireDefault(_storesTokenStore),_actionsUserActions=require("./actions/user-actions"),_actionsUserActions2=_interopRequireDefault(_actionsUserActions),_actionsHostActions=require("./actions/host-actions"),_actionsHostActions2=_interopRequireDefault(_actionsHostActions),_actionsContainerActions=require("./actions/container-actions"),_actionsContainerActions2=_interopRequireDefault(_actionsContainerActions),_actionsOrgActions=require("./actions/org-actions"),_actionsOrgActions2=_interopRequireDefault(_actionsOrgActions),_nsyncNsyncRunnerBootstrap=require("./nsync/nsync-runner-bootstrap"),_nsyncNsyncRunnerBootstrap2=_interopRequireDefault(_nsyncNsyncRunnerBootstrap),_utilIwc=require("./util/iwc"),_utilIwc2=_interopRequireDefault(_utilIwc),_config=require("./config"),_config2=_interopRequireDefault(_config),_emitter=require("./emitter"),_emitter2=_interopRequireDefault(_emitter);require("./bins");var BrowserWindow=_remote2["default"].require("browser-window"),ignoredFilePatterns=[".unison",".git",".svn",".hg","CVS",".DS_Store",".AppleDouble",".LSOverride",".Spotlight-V100",".Trashes","Thumbs.db","desktop.ini","*.lock","*.sock","*.pid","*.sw?",".unison*","._*","*~"],Nitrogen=function(){function e(){var t=this;_classCallCheck(this,e),this.subscriptions=null,this.toolbarEl=null,this.toolbarPanel=null,this.config={showWelcomeOnStartup:{type:"boolean","default":!0,description:"Show the welcome screen the next time a new window is created. This config setting is automatically set to `false` after a new window is created and welcome screen is shown."}},this.connectionDidReconnect=function(){t.fetchAll()},this.tokenStoreDidChange=function(){t.fetchAll(),t.runNsyncServerIfNeeded()},this.nsyncStoreDidChange=function(){t.runNsyncServerIfNeeded()},this.runNsyncServerIfNeeded=function(){var e=_storesTokenStore2["default"].token,t=_storesNsyncStore2["default"].runnerReady,n=_storesNsyncStore2["default"].running;e&&t&&!n&&_utilIwc2["default"].send("nsync-runner.start-server",_config2["default"].nitrousHost,e,_config2["default"].nitrousFolderPath)}}return _createClass(e,[{key:"activate",value:function(e){this.openNsyncRunner(),this.subscriptions=new _atom.CompositeDisposable,this.toolbarEl=new _elementsNitrogenToolbarElement2["default"],this.toolbarEl.deserialize(e.toolbarState),this.toolbarPanel=atom.workspace.addRightPanel({item:this.toolbarEl,visible:!0}),_welcome2["default"].activate(),_login2["default"].activate(),_containerSettings2["default"].activate(),_shell2["default"].activate(),_webview2["default"].activate(),_renameWatcher2["default"].activate(),_feedback2["default"].activate(),this.tokenStoreDidChange(),_storesTokenStore2["default"].onChange(this.tokenStoreDidChange),_storesNsyncStore2["default"].onChange(this.nsyncStoreDidChange),window.addEventListener("online",this.connectionDidReconnect,!1),this.addIgnoredFiles()}},{key:"deactivate",value:function(){_emitter2["default"].emit("deactivate"),window.removeEventListener("online",this.connectionDidReconnect,!1),_storesTokenStore2["default"].offChange(this.tokenStoreDidChange),_storesNsyncStore2["default"].offChange(this.nsyncStoreDidChange),this.toolbarPanel.destroy(),this.toolbarEl.destroy(),_welcome2["default"].deactivate(),_login2["default"].deactivate(),_containerSettings2["default"].deactivate(),_shell2["default"].deactivate(),_webview2["default"].deactivate(),_renameWatcher2["default"].deactivate(),_feedback2["default"].deactivate(),this.subscriptions.dispose()}},{key:"serialize",value:function(){return{toolbarState:this.toolbarEl.serialize()}}},{key:"fetchAll",value:function(){_storesTokenStore2["default"].token&&_actionsUserActions2["default"].fetch().then(function(){_actionsHostActions2["default"].fetchAll(),_actionsContainerActions2["default"].fetchAll(),_actionsOrgActions2["default"].fetchAll()})}},{key:"openNsyncRunner",value:function(){_utilIwc2["default"].getEnv("NSYNC_RUNNING")||!function(){_utilIwc2["default"].setEnv("NSYNC_RUNNING",!0);var e=new BrowserWindow({width:800,height:600,show:!1,"web-preferences":{"web-security":!1}});e.on("closed",function(){e=null}),e.loadUrl("atom://nitrogen/lib/nsync/nsync-runner.html"),e.webContents.once("dom-ready",function(){var t=function(e){return"'"+e.replace(/\\/g,"\\\\").replace("'","\\'")+"'"},n=require.resolve("./nsync/nsync-runner-bootstrap"),o=_path2["default"].join(__dirname,"..","node_modules"),i="("+_nsyncNsyncRunnerBootstrap2["default"].toString()+")("+t(n)+", "+t(o)+");";e.webContents.executeJavaScript(i)})}()}},{key:"addIgnoredFiles",value:function(){var e=atom.config.get("core.ignoredNames")||[];ignoredFilePatterns.forEach(function(t){-1===e.indexOf(t)&&e.push(t)}),atom.config.set("core.ignoredNames",e),atom.config.set("tree-view.hideIgnoredNames",!1),atom.config.set("tree-view.hideIgnoredNames",!0)}}]),e}();atom.config.set("welcome.showOnStartup",!1),exports["default"]=new Nitrogen,module.exports=exports["default"];