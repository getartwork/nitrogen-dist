"use strict";var remote=require("remote"),BrowserWindow=remote.require("browser-window"),currentWindow=remote.getCurrentWindow(),app=remote.require("app"),logger=require("./logger"),iwc=require("../util/iwc"),dialog=remote.require("dialog"),bins=require("../bins"),platform=require("../util/platform"),tokenStore=require("./stores/token-store"),containerStore=require("./stores/container-store"),settingStore=require("./stores/setting-store"),isMac="darwin"===process.platform,nsyncRunner={_initialized:!1,trayMenu:null,nsync:null,init:function(){var e=this;if(!this._initialized)return this._initialized=!0,this.kill=this.kill.bind(this),this.startServer=this.startServer.bind(this),window.addEventListener("keydown",function(e){87===e.keyCode&&(isMac&&e.metaKey||!isMac&&e.ctrlKey)&&currentWindow.hide(),73===e.keyCode&&e.altKey&&(isMac&&e.metaKey||!isMac&&e.ctrlKey)&&currentWindow.inspectElement(0,0)},!1),this.setupQuit(),document.getElementById("nsync-log-scrollback-field").addEventListener("change",function(e){var t=parseInt(e.currentTarget.value,10);isNaN(t)&&(t=500),logger.setScrollback(t),e.currentTarget.value=t},!1),document.getElementById("nsync-log-clear-logs").addEventListener("click",function(){logger.clear()},!1),document.getElementById("nsync-log-copy-to-clipboard").addEventListener("click",function(){logger.copyToClipboard()},!1),this.trayMenu=require("./tray-menu"),this.nsync=require("./nsync"),iwc.on("nsync-runner.start-server",this.startServer),iwc.on("nsync-runner.kill-server",this.kill),window.addEventListener("unload",function(){try{iwc.removeListener("nsync-runner.start-server",e.startServer),iwc.removeListener("nsync-runner.kill-server",e.kill),e.nsync.destroy(),iwc.setEnv("NSYNC_RUNNER_READY",!1)}catch(t){}},!1),iwc.setEnv("NSYNC_RUNNER_READY",!0),iwc.send("nsync-runner.ready"),this},kill:function(){this.nsync.kill(),tokenStore.reset(),containerStore.reset(),settingStore.reset(),this.trayMenu.render()},startServer:function(e,t,n){tokenStore.updateToken(t),this.nsync.run(e,n)},beforeExit:function(){},setupQuit:function(){var e=this,t=!1,n=function(){t=!0};app.on("before-quit",n);var r=function(){var t=function n(t){if(1===BrowserWindow.getAllWindows().length){try{e.kill(),e.trayMenu.destroy()}catch(r){}if(platform.isMac){var i=remote.require("menu"),o=i.buildFromTemplate([{label:app.getName(),submenu:[{label:"Quitting Nitrogen...",enabled:!1}]}]);i.setApplicationMenu(o),app.dock.setMenu(o)}window.setTimeout(function(){try{bins.cleanUp(),e.beforeExit()}catch(t){}app.exit(0)},300)}else{if(!(10>t)){var s=dialog.showMessageBox({type:"info",buttons:["Try Again","Cancel"],title:"Nitrogen",message:"The process of quitting Nitrogen application was interrupted.",detail:"To try quitting Nitrogen again, click Try Again."});return void(0===s&&app.quit())}window.setTimeout(function(){n(++t)},500)}};t(0)};window.addEventListener("beforeunload",function(e){if(e.returnValue=!1,currentWindow.hide(),t){t=!1;var n=dialog.showMessageBox({type:"question",buttons:["Run in Background","Quit Nitrogen"],title:"Run Nitrogen in Background?",message:"Do you want to keep Nitrogen running in the background?",detail:"This will allow file sync and port forwarding to continue running. Click Nitrogen icon in the "+(isMac?"menu bar":"system tray")+" to access Nitrogen."});1===n&&r()}return!1},!1),window.addEventListener("unload",function(){try{app.removeListener("before-quit",n)}catch(e){}},!1)}};module.exports=nsyncRunner;