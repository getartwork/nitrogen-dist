"use strict";var remote=require("remote"),BrowserWindow=remote.require("browser-window"),currentWindow=remote.getCurrentWindow(),app=remote.require("app"),logger=require("./logger"),iwc=require("../util/iwc"),dialog=remote.require("dialog"),bins=require("../bins"),platform=require("../util/platform"),tokenStore=require("./stores/token-store"),containerStore=require("./stores/container-store"),settingStore=require("./stores/setting-store"),isMac="darwin"===process.platform,nsyncRunner={_initialized:!1,trayMenu:null,nsync:null,init:function(){var e=this;if(!this._initialized)return this._initialized=!0,this.kill=this.kill.bind(this),this.startServer=this.startServer.bind(this),window.addEventListener("keydown",function(e){87===e.keyCode&&(isMac&&e.metaKey||!isMac&&e.ctrlKey)&&currentWindow.hide(),73===e.keyCode&&e.altKey&&(isMac&&e.metaKey||!isMac&&e.ctrlKey)&&currentWindow.inspectElement(0,0)},!1),this.setupQuit(),this.nsync=require("./nsync"),this.trayMenu=require("./tray-menu"),iwc.on("nsync-runner.start-server",this.startServer),iwc.on("nsync-runner.kill-server",this.kill),window.addEventListener("unload",function(){try{iwc.removeListener("nsync-runner.start-server",e.startServer),iwc.removeListener("nsync-runner.kill-server",e.kill),e.nsync.destroy(),iwc.setEnv("NSYNC_RUNNER_READY",!1)}catch(n){}},!1),iwc.setEnv("NSYNC_RUNNER_READY",!0),iwc.send("nsync-runner.ready"),this.retrievePreviousSetup(),this.initEventListners(),this},kill:function(){this.nsync&&this.nsync.kill(),tokenStore.reset(),containerStore.reset(),settingStore.reset(),this.trayMenu.render()},startServer:function(e,n,t){tokenStore.updateToken(n);var r="true"===localStorage.getItem("nitrogen:nsyncDebugEnabled");this.nsync.run(e,t,{debug:r})},beforeExit:function(){},setupQuit:function(){var e=this,n=!1,t=function(){n=!0};app.on("before-quit",t);var r=function(){var n=function t(n){if(1===BrowserWindow.getAllWindows().length){try{e.kill(),e.trayMenu.destroy()}catch(r){}if(platform.isMac){var i=remote.require("menu"),o=i.buildFromTemplate([{label:app.getName(),submenu:[{label:"Quitting Nitrogen...",enabled:!1}]}]);i.setApplicationMenu(o),app.dock.setMenu(o)}window.setTimeout(function(){try{bins.cleanUp(),e.beforeExit()}catch(n){}app.exit(0)},300)}else{if(!(10>n)){var s=dialog.showMessageBox({type:"info",buttons:["Try Again","Cancel"],title:"Nitrogen",message:"The process of quitting Nitrogen application was interrupted.",detail:"To try quitting Nitrogen again, click Try Again."});return void(0===s&&app.quit())}window.setTimeout(function(){t(++n)},500)}};n(0)};window.addEventListener("beforeunload",function(e){if(e.returnValue=!1,currentWindow.hide(),n){n=!1;var t=dialog.showMessageBox({type:"question",buttons:["Run in Background","Quit Nitrogen"],title:"Run Nitrogen in Background?",message:"Do you want to keep Nitrogen running in the background?",detail:"This will allow file sync and port forwarding to continue running. Click Nitrogen icon in the "+(isMac?"menu bar":"system tray")+" to access Nitrogen."});1===t&&r()}return!1},!1),window.addEventListener("unload",function(){try{app.removeListener("before-quit",t)}catch(e){}},!1)},initEventListners:function(){var e=this,n=document.getElementById("nsync-log-scrollback-field"),t=document.getElementById("nsync-enable-debug-log"),r=document.getElementById("nsync-log-clear-logs"),i=document.getElementById("nsync-log-copy-to-clipboard");n.addEventListener("change",function(e){var n=parseInt(e.currentTarget.value,10);isNaN(n)&&(n=500),logger.setScrollback(n),e.currentTarget.value=n,localStorage.setItem("nitrogen:nsyncLogScrollback",n)},!1),t.addEventListener("change",function(n){n.target.checked?(e.nsync.changeLogLevel("debug"),localStorage.setItem("nitrogen:nsyncDebugEnabled","true")):(e.nsync.changeLogLevel("warn"),localStorage.setItem("nitrogen:nsyncDebugEnabled","false"))},!1),r.addEventListener("click",function(){logger.clear()},!1),i.addEventListener("click",function(){logger.copyToClipboard()},!1)},retrievePreviousSetup:function(){var e=document.getElementById("nsync-log-scrollback-field"),n=document.getElementById("nsync-enable-debug-log");if(localStorage.getItem("nitrogen:nsyncLogScrollback")){var t=parseInt(localStorage.getItem("nitrogen:nsyncLogScrollback"),10);isNaN(t)||(e.value=localStorage.getItem("nitrogen:nsyncLogScrollback"),logger.setScrollback(t))}localStorage.getItem("nitrogen:nsyncDebugEnabled")&&"true"===localStorage.getItem("nitrogen:nsyncDebugEnabled")&&(n.checked=!0)}};module.exports=nsyncRunner;