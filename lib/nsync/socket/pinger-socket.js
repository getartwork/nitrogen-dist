"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),eventedSocket=require("./evented-socket");module.exports=function(){function t(e,n,i){_classCallCheck(this,t),this._url=e.replace("http","ws")+"/api/v0/hosts/"+n+"/activity?token="+encodeURIComponent(i),this._hostID=n,this._socket=null,this._lastSent=null,this._lastAck=null,this._lastFailed=null,this._pingTimeout=null,this._pingWait=5e3,this._willRunAt=0}return _createClass(t,[{key:"connect",value:function(){this._socket=new eventedSocket(this._url),this._socket.on("open",this.didOpen.bind(this)),this._socket.on("error",this.didFail.bind(this)),this._socket.on("message",this.handleMessage.bind(this)),this._socket.connect()}},{key:"disconnect",value:function(){this._socket&&(this._socket.disconnect(),this._socket=null)}},{key:"didFail",value:function(){this.pingTimeout&&clearTimeout(this.pingTimeout)}},{key:"handleMessage",value:function(t){var e=t.match(/^ok\|(\d+)/);e&&(this._lastAck=parseInt(e[1],10))}},{key:"didOpen",value:function(){this.ping()}},{key:"ping",value:function(){this._debouncePing()}},{key:"_debouncePing",value:function(){this._willRunAt-Date.now()>0||(this._willRunAt=Date.now()+this._pingWait,this._pingTimeout=setTimeout(this._ping.bind(this),this._pingWait))}},{key:"_ping",value:function(){if(!this.connected)return void(this._socket?this._socket.retry():this.connect());var t=Date.now();this._socket.send("active|"+t),this._lastSent=t}},{key:"connected",get:function(){return this._socket?this._socket.connected:!1}}]),t}();