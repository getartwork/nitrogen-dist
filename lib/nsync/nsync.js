"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ajaxWithRetry(e){var t=function(e,t){var n=1e3;e>5&&10>=e?n=2e3:e>10&&(n=5e3),window.setTimeout(t,n)};return new Promise(function(n){var i=0,o=function s(){$.ajax(e).then(function(e){n(e)},function(){t(++i,s)})};o()})}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),$=require("jquery"),iwc=require("../util/iwc"),path=require("path"),logger=require("./logger"),tokenStore=require("./stores/token-store"),containerStore=require("./stores/container-store"),settingStore=require("./stores/setting-store"),emitter=require("../emitter"),eventsSocket=require("./socket/events-socket"),immutable=require("immutable"),childProcess=require("child_process"),bins=require("../bins"),platform=require("../util/platform"),PingerSocket=require("./socket/pinger-socket"),log=logger.log,panic=logger.panic,OrderedSet=immutable.OrderedSet,Map=immutable.Map,Nsync=function(){function e(){_classCallCheck(this,e),this.reset(),this.checkIfOldDesktopAppRunning(),this.pingSockets=Map(),this.toggleFileSync=this.toggleFileSync.bind(this),this.toggleTunneling=this.toggleTunneling.bind(this),this.updateTunneledPorts=this.updateTunneledPorts.bind(this),this.connectionDidReconnect=this.connectionDidReconnect.bind(this),this.registerSSHKey=this.registerSSHKey.bind(this),this.fetchVersion=this.fetchVersion.bind(this),this.ping=this.ping.bind(this),iwc.on("nsync.toggle-file-sync",this.toggleFileSync),iwc.on("nsync.toggle-tunneling",this.toggleTunneling),iwc.on("nsync.update-tunneled-ports",this.updateTunneledPorts),iwc.on("nsync.register-ssh-key",this.registerSSHKey),iwc.on("nsync.fetch-version",this.fetchVersion),iwc.on("nsync.ping",this.ping),window.addEventListener("online",this.connectionDidReconnect,!1)}return _createClass(e,[{key:"reset",value:function(){this._running=!1,this._proc=null,this._port=null,this._nitrousHost=null,this._folderPath=null,this._ready=!1,this.pingSockets&&this.pingSockets.forEach(function(e){e.disconnect()})}},{key:"destroy",value:function(){this.reset(),iwc.removeListener("nsync.toggle-file-sync",this.toggleFileSync),iwc.removeListener("nsync.toggle-tunneling",this.toggleTunneling),iwc.removeListener("nsync.update-tunneled-ports",this.updateTunneledPorts),iwc.removeListener("nsync.register-ssh-key",this.registerSSHKey),iwc.removeListener("nsync.fetch-version",this.fetchVersion),iwc.removeListener("nsync.ping",this.ping),window.removeEventListener("online",this.connectionDidReconnect,!1)}},{key:"fetchAll",value:function(){return this.fetchContainers()}},{key:"fetchAllSharedContainers",value:function(){return this.fetchSharedContainers()}},{key:"connectionDidReconnect",value:function(){this.fetchAll(),this.fetchAllSharedContainers()}},{key:"run",value:function(e,t,n){var i=this;if(this._running||!tokenStore.token||!t)return!1;this._running=!0,this._nitrousHost=e,this._folderPath=t,this.fetchAll().then(function(){i.fetchAllSharedContainers().then(function(){i.restoreSession()})}),this.subscribeToEventSocketEvents(),this.subscribeToNsyncEvents(),log("Running Nsync...\n");var o=bins.nsync,s={};n.debug&&(s.NSYNC_LOG_LEVEL="debug");var r=this._proc=childProcess.spawn(o,[],{cwd:path.dirname(o),env:Object.assign({},iwc.getEnv(),s),detached:!1});return["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(e){process.on(e,function(){try{r.kill("SIGTERM")}catch(e){}})}),r.on("close",function(e){log("\nProcess exited with code "+e),i._proc=null}),r.stdout.on("data",this._handleOutput.bind(this)),r.stderr.on("data",this._handleOutput.bind(this)),!0}},{key:"fetchVersion",value:function(){var e=bins.nsync,t=bins.nsyncSsh,n=null,i=null;return childProcess.exec(e+" -v",function(e,t,o){return e?void log(e.message):(o&&log(o),n=t.trim(),void(n&&i&&iwc.send("nsync.fetched-version",n,i)))}),childProcess.exec(t+" -v",function(e,t,o){return e?void log(e.message):(o&&log(o),i=t.trim(),void(n&&i&&iwc.send("nsync.fetched-version",n,i)))}),!0}},{key:"checkIfOldDesktopAppRunning",value:function(){var e=void 0,t=void 0;platform.isMac?e="pgrep -x Nitrous":platform.isWindows?e='TASKLIST /fi "Imagename eq nitrous.exe"':platform.isLinux&&(e="pgrep -x nitrous"),childProcess.exec(e,function(e,n,i){return e?void(1!==e.code&&log(e.message)):i?void log(i):(t=n.trim(),void((platform.isWindows&&t.includes("nitrous.exe")||!platform.isWindows&&t.length>0)&&emitter.emit("show-notification","We have detected that you are running the Nitrous Desktop App. Please exit it before running Nitrogen")))})}},{key:"_handleOutput",value:function(e){e=new Buffer(e).toString("utf8"),log(e),e.split("\n").forEach(function(e){var t="[nsync event] ";if(e.startsWith(t))try{var n=JSON.parse(e.slice(t.length));emitter.emit("nsync:"+n.name,n.data)}catch(i){}})}},{key:"_makeInitRequest",value:function(){var e=this,t=this._port,n=ajaxWithRetry({type:"POST",url:"http://127.0.0.1:"+t+"/init",dataType:"json",data:{host:this._nitrousHost,token:tokenStore.token,path:this._folderPath}});return n.then(function(){e._ready=!0,iwc.setEnv("NSYNC_PORT",t),e.restoreSession(),iwc.send("nsync-runner.server-running",t)}),n}},{key:"restoreSession",value:function(){var e=this;containerStore.fetched&&settingStore.loaded&&this._ready&&containerStore.liveContainers.forEach(function(t,n){var i=settingStore.getSetting(n);return"running"!==t.state?(i.syncEnabled&&settingStore.updateSetting(n,"syncState","stopped"),void(i.tunnelingEnabled&&settingStore.updateSetting(n,"tunnelingEnabled",!1))):(i.syncEnabled&&(settingStore.updateSetting(n,"syncState","starting"),e.makeFileSyncRequest(n,!0,"stopped")),void(i.tunnelingEnabled&&e.makeTunnelingRequest(n,!0)))})}},{key:"kill",value:function(){this._proc&&this._proc.kill(),this.reset(),iwc.setEnv("NSYNC_PORT",""),iwc.send("nsync-runner.server-killed")}},{key:"fetchContainers",value:function(){var e=ajaxWithRetry({type:"GET",url:this._nitrousHost+"/api/v0/containers",dataType:"json",headers:{Authorization:"Bearer "+tokenStore.token}});return e.then(function(e){containerStore.updateContainers(e.containers)}),e}},{key:"fetchSharedContainers",value:function(){var e=ajaxWithRetry({type:"GET",url:this._nitrousHost+"/api/v0/shared_containers",dataType:"json",headers:{Authorization:"Bearer "+tokenStore.token}});return e.then(function(e){containerStore.updateSharedContainers(e.containers)}),e}},{key:"makeFileSyncRequest",value:function(e,t,n){var i=this._port;$.ajax({type:"POST",url:"http://127.0.0.1:"+i+"/containers/"+e+"/sync/"+(t?"start":"stop"),dataType:"json",data:{remote_path:"code"}}).fail(function(){settingStore.updateSetting(e,"syncState",n),emitter.emit("show-notification","Failed to "+(t?"Enable":"Disable")+" Sync: "+e)})}},{key:"toggleFileSync",value:function(e){if(this._ready){var t=settingStore.getSetting(e),n=!1,i=t.syncState;t.syncEnabled?(n=!1,settingStore.updateSetting(e,"syncState","stopping")):(n=!0,settingStore.updateSetting(e,"syncState","starting")),this.makeFileSyncRequest(e,n,i)}}},{key:"makeTunnelingRequest",value:function(e,t){var n=this._port;$.ajax({type:"POST",url:"http://127.0.0.1:"+n+"/containers/"+e+"/tunnel/"+(t?"start":"stop"),dataType:"json",data:{ports:settingStore.getSetting(e).tunneledPorts.join(",")}}).fail(function(){settingStore.updateSetting(e,"tunnelingEnabled",!t),emitter.emit("show-notification","Failed to "+(t?"Enable":"Disable")+" Port Forwarding: "+e)})}},{key:"toggleTunneling",value:function(e){if(this._ready){var t=settingStore.getSetting(e),n=!t.tunnelingEnabled;if(n&&0===t.tunneledPorts.size)return void emitter.emit("show-notification","Port forwarding is not configured");settingStore.updateSetting(e,"tunnelingEnabled",n),this.makeTunnelingRequest(e,n)}}},{key:"updateTunneledPorts",value:function(e,t){this._ready&&(settingStore.updateSetting(e,"tunneledPorts",OrderedSet(t)),settingStore.getSetting(e).tunnelingEnabled&&this.makeTunnelingRequest(e,!0))}},{key:"registerSSHKey",value:function(e){this._ready&&$.ajax({type:"POST",url:"http://127.0.0.1:"+this._port+"/containers/"+e+"/register_ssh_key",dataType:"json"}).done(function(){iwc.send("nsync.ssh-key-registered",e)})}},{key:"changeLogLevel",value:function(e){$.ajax({type:"PUT",url:"http://127.0.0.1:"+this._port+"/settings",dataType:"json",data:{log_level:e}})}},{key:"ping",value:function(e){if(this._ready){var t=containerStore.getContainer(e);if(!t)return void log("nsync.ping: container does not exists",e);var n=this.pingSockets.get(t.hostId);n||(n=new PingerSocket(this._nitrousHost,t.hostId,tokenStore.token),this.pingSockets=this.pingSockets.set(t.hostId,n)),n.ping()}}},{key:"subscribeToEventSocketEvents",value:function(){var e=this;eventsSocket.connect(this._nitrousHost+"/api/v0/events",tokenStore.token);var t=function(e){e.container&&containerStore.updateContainer(e.container.slug,e.container)},n=function(t){if(t){var n=settingStore.getSetting(t);n.tunnelingEnabled&&e.toggleTunneling(t),n.syncEnabled&&e.toggleFileSync(t)}};["events:container.created","events:container.starting","events:container.stopped","events:container.reconfigure-failed","events:container.started","events:container.restarted","events:container.reconfigured"].forEach(function(e){emitter.on(e,function(e){t(e)})}),["events:container.reconfiguring","events:container.stopping","events:container.restarting","events:container.destroying","events:container.destroyed"].forEach(function(e){emitter.on(e,function(e){t(e),e.container&&n(e.container.slug)})}),["events:host.restarting","events:host.stopping","events:host.destroying"].forEach(function(e){emitter.on(e,function(e){e.host&&e.host.id&&!function(){var t=e.host.id,i=containerStore.liveContainers.filter(function(e){return e.hostId===t});i.forEach(function(e){n(e.slug)})}()})})}},{key:"subscribeToNsyncEvents",value:function(){var e=this;emitter.on("nsync:listening",function(t){return t?(e._port=t,void window.setTimeout(function(){e._makeInitRequest()},100)):panic(new Error("malformed port detected"))}),emitter.on("nsync:container.sync-enabled",function(e){settingStore.updateSetting(e.slug,"syncState","running"),emitter.emit("show-notification","Sync Enabled: "+e.slug)}),emitter.on("nsync:container.sync-disabled",function(e){settingStore.updateSetting(e.slug,"syncState","stopped"),emitter.emit("show-notification","Sync Paused: "+e.slug)}),emitter.on("nsync:container.sync-started",function(t){settingStore.updateSetting(t.slug,"syncState","syncing"),e.ping(t.slug)}),emitter.on("nsync:container.sync-finished",function(e){settingStore.updateSetting(e.slug,"syncState","running")}),emitter.on("nsync:container.started-port-forwarding",function(e){settingStore.updateSetting(e.slug,"tunnelingEnabled",!0),emitter.emit("show-notification","Port Forwarding Started: "+e.slug)}),emitter.on("nsync:container.stopped-port-forwarding",function(e){settingStore.updateSetting(e.slug,"tunnelingEnabled",!1),emitter.emit("show-notification","Port Forwarding Disabled: "+e.slug)})}}]),e}();module.exports=new Nsync;