"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ajaxWithRetry(t){var e=function(t,e){var n=1e3;t>5&&10>=t?n=2e3:t>10&&(n=5e3),window.setTimeout(e,n)};return new Promise(function(n){var i=0,o=function r(){$.ajax(t).then(function(t){n(t)},function(){e(++i,r)})};o()})}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),$=require("jquery"),iwc=require("../util/iwc"),platform=require("../util/platform"),path=require("path"),logger=require("./logger"),tokenStore=require("./stores/token-store"),containerStore=require("./stores/container-store"),settingStore=require("./stores/setting-store"),emitter=require("../emitter"),eventsSocket=require("./socket/events-socket"),immutable=require("immutable"),log=logger.log,panic=logger.panic,OrderedSet=immutable.OrderedSet,Nsync=function(){function t(){_classCallCheck(this,t),this.reset(),iwc.on("nsync.toggle-file-sync",this.toggleFileSync.bind(this)),iwc.on("nsync.toggle-tunneling",this.toggleTunneling.bind(this)),iwc.on("nsync.update-tunneled-ports",this.updateTunneledPorts.bind(this)),window.addEventListener("online",this.connectionDidReconnect.bind(this),!1)}return _createClass(t,[{key:"reset",value:function(){this._running=!1,this._proc=null,this._port=null,this._nitrousHost=null,this._folderPath=null,this._ready=!1}},{key:"fetchAll",value:function(){return this.fetchContainers()}},{key:"connectionDidReconnect",value:function(){this.fetchAll()}},{key:"run",value:function(t,e){var n=this;if(this._running||!tokenStore.token||!e)return!1;this._running=!0,this._nitrousHost=t,this._folderPath=e,this.fetchAll().then(function(){n.restoreSession()}),this.subscribeToEventSocketEvents(),this.subscribeToNsyncEvents();var i=require("child_process"),o=path.join(__dirname,"..","..","nsync");if(platform.isMac)o=path.join(o,"osx64","nsync");else if(platform.isWindows)o=path.join(o,"win32","nsync.exe");else{if(!platform.isLinux)return panic(new Error("unsupported platform"));o=path.join(o,"lin64","nsync")}log("Running Nsync...\n");var r=this._proc=i.spawn(o,[],{cwd:path.dirname(o),env:iwc.getEnv(),detached:!1});return["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.on(t,function(){r.kill("SIGTERM")})}),r.on("close",function(t){log("\nProcess exited with code "+t),n._proc=null}),r.stdout.on("data",this._handleOutput.bind(this)),r.stderr.on("data",this._handleOutput.bind(this)),!0}},{key:"_handleOutput",value:function(t){t=new Buffer(t).toString("utf8"),log(t),t.split("\n").forEach(function(t){var e="[nsync event] ";if(t.startsWith(e))try{var n=JSON.parse(t.slice(e.length));emitter.emit("nsync:"+n.name,n.data)}catch(i){}})}},{key:"_makeInitRequest",value:function(){var t=this,e=this._port,n=ajaxWithRetry({type:"POST",url:"http://127.0.0.1:"+e+"/init",dataType:"json",data:{host:this._nitrousHost,token:tokenStore.token,path:this._folderPath}});return n.then(function(){t._ready=!0,iwc.setEnv("NSYNC_PORT",e),t.restoreSession(),iwc.send("nsync-runner.server-running",e)}),n}},{key:"restoreSession",value:function(){var t=this;containerStore.fetched&&settingStore.loaded&&this._ready&&containerStore.liveContainers.forEach(function(e,n){var i=settingStore.getSetting(n);return"running"!==e.state?(i.syncEnabled&&settingStore.updateSetting(n,"syncState","stopped"),void(i.tunnelingEnabled&&settingStore.updateSetting(n,"tunnelingEnabled",!1))):(i.syncEnabled&&(settingStore.updateSetting(n,"syncState","starting"),t.makeFileSyncRequest(n,!0,"stopped")),void(i.tunnelingEnabled&&t.makeTunnelingRequest(n,!0)))})}},{key:"kill",value:function(){this._proc&&this._proc.kill(),this.reset(),iwc.setEnv("NSYNC_PORT",""),iwc.send("nsync-runner.server-killed")}},{key:"fetchContainers",value:function(){var t=ajaxWithRetry({type:"GET",url:this._nitrousHost+"/api/v0/containers",dataType:"json",headers:{Authorization:"Bearer "+tokenStore.token}});return t.then(function(t){containerStore.updateContainers(t.containers)}),t}},{key:"makeFileSyncRequest",value:function(t,e,n){var i=this._port;$.ajax({type:"POST",url:"http://127.0.0.1:"+i+"/containers/"+t+"/sync/"+(e?"start":"stop"),dataType:"json",data:{remote_path:"code"}}).fail(function(){settingStore.updateSetting(t,"syncState",n),emitter.emit("show-notification","Failed to "+(e?"Enable":"Disable")+" Sync: "+t)})}},{key:"toggleFileSync",value:function(t){if(this._ready){var e=settingStore.getSetting(t),n=!1,i=e.syncState;e.syncEnabled?(n=!1,settingStore.updateSetting(t,"syncState","stopping")):(n=!0,settingStore.updateSetting(t,"syncState","starting")),this.makeFileSyncRequest(t,n,i)}}},{key:"makeTunnelingRequest",value:function(t,e){var n=this._port;$.ajax({type:"POST",url:"http://127.0.0.1:"+n+"/containers/"+t+"/tunnel/"+(e?"start":"stop"),dataType:"json",data:{ports:settingStore.getSetting(t).tunneledPorts.join(",")}}).fail(function(){settingStore.updateSetting(t,"tunnelingEnabled",!e),emitter.emit("show-notification","Failed to "+(e?"Enable":"Disable")+" Port Forwarding: "+t)})}},{key:"toggleTunneling",value:function(t){if(this._ready){var e=settingStore.getSetting(t),n=!e.tunnelingEnabled;if(n&&0===e.tunneledPorts.size)return void emitter.emit("show-notification","Port forwarding is not configured");settingStore.updateSetting(t,"tunnelingEnabled",n),this.makeTunnelingRequest(t,n)}}},{key:"updateTunneledPorts",value:function(t,e){this._ready&&(settingStore.updateSetting(t,"tunneledPorts",OrderedSet(e)),settingStore.getSetting(t).tunnelingEnabled&&this.makeTunnelingRequest(t,!0))}},{key:"subscribeToEventSocketEvents",value:function(){var t=this;eventsSocket.connect(this._nitrousHost+"/api/v0/events",tokenStore.token);var e=function(t){t.container&&containerStore.updateContainer(t.container.slug,t.container)},n=function(e){if(e){var n=settingStore.getSetting(e);n.tunnelingEnabled&&t.toggleTunneling(e),n.syncEnabled&&t.toggleFileSync(e)}};["events:container.created","events:container.starting","events:container.stopped","events:container.reconfigure-failed","events:container.started","events:container.restarted","events:container.reconfigured"].forEach(function(t){emitter.on(t,function(t){e(t)})}),["events:container.reconfiguring","events:container.stopping","events:container.restarting","events:container.destroying","events:container.destroyed"].forEach(function(t){emitter.on(t,function(t){e(t),t.container&&n(t.container.slug)})}),["events:host.restarting","events:host.stopping","events:host.destroying"].forEach(function(t){emitter.on(t,function(t){t.host&&t.host.id&&!function(){var e=t.host.id,i=containerStore.liveContainers.filter(function(t){return t.hostId===e});i.forEach(function(t){containerStore.updateContainer(t.slug,t.set("state","host_stopped")),n(t.slug)})}()})})}},{key:"subscribeToNsyncEvents",value:function(){var t=this;emitter.on("nsync:listening",function(e){return e?(t._port=e,void window.setTimeout(function(){t._makeInitRequest()},100)):panic(new Error("malformed port detected"))}),emitter.on("nsync:container.sync-enabled",function(t){settingStore.updateSetting(t.slug,"syncState","running"),emitter.emit("show-notification","Sync Enabled: "+t.slug)}),emitter.on("nsync:container.sync-disabled",function(t){settingStore.updateSetting(t.slug,"syncState","stopped"),emitter.emit("show-notification","Sync Paused: "+t.slug)}),emitter.on("nsync:container.sync-started",function(t){settingStore.updateSetting(t.slug,"syncState","syncing")}),emitter.on("nsync:container.sync-finished",function(t){settingStore.updateSetting(t.slug,"syncState","running")}),emitter.on("nsync:container.started-port-forwarding",function(t){settingStore.updateSetting(t.slug,"tunnelingEnabled",!0),emitter.emit("show-notification","Port Forwarding Started: "+t.slug)}),emitter.on("nsync:container.stopped-port-forwarding",function(t){settingStore.updateSetting(t.slug,"tunnelingEnabled",!1),emitter.emit("show-notification","Port Forwarding Disabled: "+t.slug)})}}]),t}();module.exports=new Nsync;