"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_get=function(e,t,i){for(var r=!0;r;){var s=e,n=t,a=i;r=!1,null===s&&(s=Function.prototype);var u=Object.getOwnPropertyDescriptor(s,n);if(void 0!==u){if("value"in u)return u.value;var o=u.get;if(void 0===o)return;return o.call(a)}var l=Object.getPrototypeOf(s);if(null===l)return;e=l,t=n,i=a,r=!0,u=l=void 0}},_store=require("./store"),_store2=_interopRequireDefault(_store),_hostStore=require("./host-store"),_hostStore2=_interopRequireDefault(_hostStore),_recordsUser=require("../records/user"),_recordsUser2=_interopRequireDefault(_recordsUser),timeToFixUsage=60,tickInterval=1e3,UserStore=function(e){function t(){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this._user=null,this._usageRemaining=0,this._usageSinceStarted=0,this._timer=null,this._startedTime=null}return _inherits(t,e),_createClass(t,[{key:"handleAction",value:function(e){switch(e.type){case"token.invalidate":this._user=null,this._lastError=null,this._usageRemaining=0,this._usageSinceStarted=0;break;case"user.fetched":var t=e.data.data;this._user=_recordsUser2["default"].deserialize(t.user),this._usageRemaining=this._user.usageRemaining,this.tickUsageRemaining(),this._lastError=null;break;case"user.fetch-failed":this._user=null,this.handleErrorJqxhr(e.data.jqxhr),this._usageRemaining=0,this._usageSinceStarted=0;break;default:return}this.notifyChange()}},{key:"tickUsageRemaining",value:function(){this.stopTickUsageRemaining(),this._startedTime=new Date,this._usageSinceStarted=0,this._timer=setInterval(this._updateUsageRemaining.bind(this),tickInterval)}},{key:"stopTickUsageRemaining",value:function(){this._timer&&(clearInterval(this._timer),this._timer=null)}},{key:"_updateUsageRemaining",value:function(){if(_hostStore2["default"].hasPaidHosts&&this.stopTickUsageRemaining(),this._usageRemaining<=0)clearInterval(this._timer),this._timer=null,this._usageRemaining=0,this._usageSinceStarted=0;else{if(0!==_hostStore2["default"].stoppedFreeHosts.size)return void(this._startedTime=new Date);this._usageRemaining=this._usageRemaining-1,this._usageSinceStarted=this._usageSinceStarted+1,this._usageSinceStarted%timeToFixUsage===0&&this._fixUsage()}this.emit("usage-remaining.tick")}},{key:"_fixUsage",value:function(){var e=new Date,t=Math.round((e-this._startedTime)/1e3);Math.abs(t-this._usageSinceStarted)>0&&(this._usageRemaining-=t-this._usageSinceStarted,this._usageSinceStarted=t)}},{key:"user",get:function(){return this._user}},{key:"username",get:function(){return this._user?this._user.username:null}},{key:"usageRemaining",get:function(){return this._usageRemaining}},{key:"nextUsageQuotaAt",get:function(){return this._user?this._user.nextUsageQuotaAt:null}}]),t}(_store2["default"]);exports["default"]=new UserStore,module.exports=exports["default"];