"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),_get=function(e,t,o){for(var i=!0;i;){var n=e,r=t,a=o;i=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,r);if(void 0!==s){if("value"in s)return s.value;var l=s.get;if(void 0===l)return;return l.call(a)}var u=Object.getPrototypeOf(n);if(null===u)return;e=u,t=r,o=a,i=!0,s=u=void 0}},_react=require("react"),_react2=_interopRequireDefault(_react),_atom=require("atom"),_storesUserStore=require("../stores/user-store"),_storesUserStore2=_interopRequireDefault(_storesUserStore),_utilPlatform=require("../util/platform"),_utilPlatform2=_interopRequireDefault(_utilPlatform),_utilIwc=require("../util/iwc"),_utilIwc2=_interopRequireDefault(_utilIwc),_path=require("path"),_path2=_interopRequireDefault(_path),_child_process=require("child_process"),_child_process2=_interopRequireDefault(_child_process),_ajax=require("../ajax"),_config=require("../config"),_config2=_interopRequireDefault(_config),_clipboard=require("clipboard"),_clipboard2=_interopRequireDefault(_clipboard),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),NitrogenShell=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this.displayName="NitrogenShell",this._iframeLoaded=!1,this._proc=null,this._subscriptions=null,this.state={sshUrl:null,username:_storesUserStore2["default"].username,cover:!1},this.userStoreDidChange=function(){e.setState({username:_storesUserStore2["default"].username},function(){e.initializeTerm()})},this.iframeDidLoad=function(){e._iframeLoaded=!0,e.initializeTerm()},this.setFont=function(){var t=e.getIframeWindow();if(atom.config&&atom.config.settings&&atom.config.settings.editor){var o=atom.config.settings.editor;t.termSetFont(o.fontFamily,o.fontSize,o.lineHeight)}},this.killProc=function(){var t=e._proc;t&&t.kill("SIGTERM")}}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=this;_storesUserStore2["default"].onChange(this.userStoreDidChange),this.refs.iframe.addEventListener("load",this.iframeDidLoad,!1),this.fetchSSHUrl(this.props.containerSlug),this._subscriptions=new _atom.CompositeDisposable,this._subscriptions.add(atom.config.onDidChange("editor.fontFamily",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.fontSize",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.lineHeight",this.setFont)),process.setMaxListeners(200),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.on(t,e.killProc)})}},{key:"componentWillReceiveProps",value:function(e){e.containerSlug!==this.props.containerSlug&&this.fetchSSHUrl(e.containerSlug)}},{key:"componentWillUnmount",value:function(){var e=this;_storesUserStore2["default"].offChange(this.userStoreDidChange),this.refs.iframe.removeEventListener("load",this.iframeDidLoad,!1),this.teardown(),this._subscriptions.dispose(),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.removeListener(t,e.killProc)})}},{key:"fetchSSHUrl",value:function(e){var t=this;e&&(0,_ajax.authedAjax)({type:"GET",url:"/api/v0/containers/"+e,dataType:"json"}).then(function(e){t.setState({sshUrl:e.container.ssh_url},function(){t.initializeTerm()})},function(){})}},{key:"initializeTerm",value:function(){var e=this,t=this.state,o=t.sshUrl,i=t.username;if(o&&i&&this._iframeLoaded){var n=this.getIframeWindow();this.setFont(),n.termStart();var r=this._proc;if(!r){var a=_path2["default"].join(__dirname,"..","..","nsync");if(_utilPlatform2["default"].isMac)a=_path2["default"].join(a,"osx64","nsync-ssh");else if(_utilPlatform2["default"].isWindows)a=_path2["default"].join(a,"win32","nsync-ssh.exe");else{if(!_utilPlatform2["default"].isLinux)throw new Error("unsupported platform");a=_path2["default"].join(a,"lin64","nsync-ssh")}var s=o.match(/\/\/([^@]+)@([^:]+):(\d+)$/),l=s[1],u=s[2],c=s[3],f=n.termGetSize(),p=["-l",l,"-p",c,u,"-i",_path2["default"].join(_config2["default"].nitrousFolderPath,"SSH Keys",i,"id_rsa").replace(/ /g,Array(6).join(_path2["default"].sep)),"-z","$SHELL","-l"],d={name:"xterm-256color",cols:f.columns||80,rows:f.lines||25,cwd:_path2["default"].dirname(a),env:Object.assign({},_utilIwc2["default"].getEnv(),{TERM:"xterm-256color"})};r=this._proc=_child_process2["default"].spawn(a,p,d),r.on("close",function(){var t=e.getIframeWindow();t&&t.termWrite("[Session closed]")}),r.stdout.on("data",function(t){var o=e.getIframeWindow();o&&o.termWrite(t.toString())}),r.stderr.on("data",function(t){var o=e.getIframeWindow();o&&o.termWrite(t.toString())})}n.onTermResize=function(t,o){var i=e._proc;i&&i.stdin.write("[8;"+o+";"+t+"t")},n.onTermInput=function(t){var o=e._proc;o&&o.stdin.write(t)},n.onTermTitle=function(t){var o=e.props.onTitleChange;"function"==typeof o&&o(t)},n.onKeyPrevTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-previous-item")},n.onKeyNextTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-next-item")},n.onKeyCloseTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"tabs:close-tab")},n.onKeyCloseWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"window:close")},n.onKeyNewWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"application:new-window")},n.onCopy=function(e){_clipboard2["default"].writeText(e)},n.onPaste=function(){return _clipboard2["default"].readText()};var m=null;n.onWindowResize=function(){window.clearTimeout(m),e.state.cover||e.setState({cover:!0}),m=window.setTimeout(function(){e.setState({cover:!1})},300)},n.termSizeToFit()}}},{key:"getIframeWindow",value:function(){return this.refs.iframe&&this.refs.iframe.contentWindow}},{key:"focusShell",value:function(){var e=this.getIframeWindow();e&&e.focus()}},{key:"teardown",value:function(){var e=this.getIframeWindow();e&&(e.onTermInput=null,e.onTermResize=null,e.onTermTitle=null,e.onKeyPrevTab=null,e.onKeyNextTab=null,e.onKeyCloseTab=null,e.onKeyCloseWindow=null,e.onKeyNewWindow=null,e.onCopy=null,e.onPaste=null,e.onWindowResize=null);var t=this._proc;t&&t.connected&&t.send({event:"pty.quit"}),this._proc=null}},{key:"render",value:function(){var e=this.state.cover;return _react2["default"].createElement("div",{className:(0,_classnames2["default"])("nitrogen-shell-component",{cover:e})},_react2["default"].createElement("iframe",{src:"atom://nitrogen/lib/shell/shell.html",ref:"iframe"}))}}],[{key:"propTypes",value:{containerSlug:_react.PropTypes.string,onTitleChange:_react.PropTypes.func},enumerable:!0}]),t}(_react2["default"].Component);exports["default"]=NitrogenShell,module.exports=exports["default"];