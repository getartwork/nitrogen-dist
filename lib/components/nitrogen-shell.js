"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function(e,t,n){for(var i=!0;i;){var r=e,o=t,s=n;i=!1,null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,o);if(void 0!==a){if("value"in a)return a.value;var c=a.get;if(void 0===c)return;return c.call(s)}var l=Object.getPrototypeOf(r);if(null===l)return;e=l,t=o,n=s,i=!0,a=l=void 0}},_react=require("react"),_react2=_interopRequireDefault(_react),_atom=require("atom"),_storesUserStore=require("../stores/user-store"),_storesUserStore2=_interopRequireDefault(_storesUserStore),_utilIwc=require("../util/iwc"),_utilIwc2=_interopRequireDefault(_utilIwc),_path=require("path"),_path2=_interopRequireDefault(_path),_child_process=require("child_process"),_child_process2=_interopRequireDefault(_child_process),_ajax=require("../ajax"),_config=require("../config"),_config2=_interopRequireDefault(_config),_clipboard=require("clipboard"),_clipboard2=_interopRequireDefault(_clipboard),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_bins=require("../bins"),_bins2=_interopRequireDefault(_bins),_emitter=require("../emitter"),_emitter2=_interopRequireDefault(_emitter),_storesNsyncStore=require("../stores/nsync-store"),_storesNsyncStore2=_interopRequireDefault(_storesNsyncStore),NitrogenShell=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this.displayName="NitrogenShell",this._iframeLoaded=!1,this._sshKeyRegistered=!1,this._proc=null,this._subscriptions=null,this.state={sshUrl:null,username:_storesUserStore2["default"].username,cover:!1},this.userStoreDidChange=function(){var t=e.state.username,n=_storesUserStore2["default"].username;t!==n&&e.setState({username:n},function(){e.initializeTerm()})},this.iframeDidLoad=function(){e._iframeLoaded=!0,e.initializeTerm()},this.setFont=function(){var t=e.getIframeWindow();if(t&&atom.config&&atom.config.settings&&atom.config.settings.editor){var n=atom.config.settings.editor;t.termSetFont(n.fontFamily,n.fontSize,n.lineHeight)}},this.killProc=function(){var t=e._proc;t&&t.kill("SIGTERM")}}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=this;_storesUserStore2["default"].onChange(this.userStoreDidChange),this.refs.iframe.addEventListener("load",this.iframeDidLoad,!1),this.fetchSSHUrl(this.props.containerSlug),this.registerSSHKey(this.props.containerSlug),this._subscriptions=new _atom.CompositeDisposable,this._subscriptions.add(atom.config.onDidChange("editor.fontFamily",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.fontSize",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.lineHeight",this.setFont)),process.setMaxListeners(200),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.on(t,e.killProc)}),_emitter2["default"].on("deactivate",this.killProc)}},{key:"componentWillReceiveProps",value:function(e){e.containerSlug!==this.props.containerSlug&&(this.fetchSSHUrl(e.containerSlug),this.registerSSHKey(e.containerSlug))}},{key:"componentWillUnmount",value:function(){var e=this;_storesUserStore2["default"].offChange(this.userStoreDidChange),this.refs.iframe.removeEventListener("load",this.iframeDidLoad,!1),this.teardown(),this._subscriptions.dispose(),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.removeListener(t,e.killProc)})}},{key:"fetchSSHUrl",value:function(e){var t=this;e&&(0,_ajax.authedAjax)({type:"GET",url:"/api/v0/containers/"+e,dataType:"json"}).then(function(e){t.state.sshUrl!==e.container.ssh_url&&t.setState({sshUrl:e.container.ssh_url},function(){t.initializeTerm()})},function(){})}},{key:"registerSSHKey",value:function(e){var t=this;e&&!function(){var n=function i(n){e===n&&(_utilIwc2["default"].off("nsync.ssh-key-registered",i),t._sshKeyRegistered=!0,t.initializeTerm())};_utilIwc2["default"].on("nsync.ssh-key-registered",n),_storesNsyncStore2["default"].running?_utilIwc2["default"].send("nsync.register-ssh-key",e):_utilIwc2["default"].once("nsync-runner.server-running",function(){_utilIwc2["default"].send("nsync.register-ssh-key",e)})}()}},{key:"initializeTerm",value:function(){var e=this,t=this.state,n=t.sshUrl,i=t.username;if(n&&i&&this._sshKeyRegistered&&this._iframeLoaded){var r=this.getIframeWindow();this.setFont(),r.termStart();var o=this._proc;if(!o){var s=n.match(/\/\/([^@]+)@([^:]+):(\d+)$/),a=s[1],c=s[2],l=s[3],u=r.termGetSize(),f=_bins2["default"].nsyncSsh,d=["-l",a,"-p",l,c,"-i",_path2["default"].join(_config2["default"].nitrousFolderPath,"SSH Keys",i,"id_rsa").replace(/ /g,Array(6).join(_path2["default"].sep)),"-z","$SHELL","-l"],p={name:"xterm-256color",cols:u.columns||80,rows:u.lines||25,cwd:_path2["default"].dirname(f),env:Object.assign({},_utilIwc2["default"].getEnv(),{TERM:"xterm-256color"})};o=this._proc=_child_process2["default"].spawn(f,d,p),o.on("close",function(){var t=e.getIframeWindow();t&&t.termWrite("[Session closed]")}),o.stdout.on("data",function(t){var n=e.getIframeWindow();n&&n.termWrite(t.toString()),process.nextTick(function(){_utilIwc2["default"].send("nsync.ping",e.props.containerSlug)})}),o.stderr.on("data",function(t){var n=e.getIframeWindow();n&&n.termWrite(t.toString()),process.nextTick(function(){_utilIwc2["default"].send("nsync.ping",e.props.containerSlug)})})}r.onTermResize=function(t,n){var i=e._proc;i&&i.stdin&&i.stdin.writable&&i.stdin.write("[8;"+n+";"+t+"t")},r.onTermInput=function(t){var n=e._proc;n&&n.stdin&&n.stdin.writable&&n.stdin.write(t),process.nextTick(function(){_utilIwc2["default"].send("nsync.ping",e.props.containerSlug)})},r.onTermTitle=function(t){var n=e.props.onTitleChange;"function"==typeof n&&n(t)},r.onKeyPrevTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-previous-item")},r.onKeyNextTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-next-item")},r.onKeyCloseTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"tabs:close-tab")},r.onKeyCloseWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"window:close")},r.onKeyNewWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"application:new-window")},r.onCopy=function(e){var t=String.fromCharCode(160),n=new RegExp(""+t,"g");_clipboard2["default"].writeText(e.replace(n," "))},r.onPaste=function(){return _clipboard2["default"].readText()};var h=null;r.onWindowResize=function(){window.clearTimeout(h),e.state.cover||e.setState({cover:!0}),h=window.setTimeout(function(){e.setState({cover:!1})},300)},r.termSizeToFit()}}},{key:"getIframeWindow",value:function(){return this.refs.iframe&&this.refs.iframe.contentWindow}},{key:"focusShell",value:function(){var e=this.getIframeWindow();e&&e.focus()}},{key:"teardown",value:function(){var e=this.getIframeWindow();e&&(e.onTermInput=null,e.onTermResize=null,e.onTermTitle=null,e.onKeyPrevTab=null,e.onKeyNextTab=null,e.onKeyCloseTab=null,e.onKeyCloseWindow=null,e.onKeyNewWindow=null,e.onCopy=null,e.onPaste=null,e.onWindowResize=null);var t=this._proc;t&&t.connected&&t.send({event:"pty.quit"}),this._proc=null}},{key:"render",value:function(){var e=this.state.cover;return _react2["default"].createElement("div",{className:(0,_classnames2["default"])("nitrogen-shell-component",{cover:e})},_react2["default"].createElement("iframe",{src:"atom://nitrogen/lib/shell/shell.html",ref:"iframe"}))}}],[{key:"propTypes",value:{containerSlug:_react.PropTypes.string,onTitleChange:_react.PropTypes.func},enumerable:!0}]),t}(_react2["default"].Component);exports["default"]=NitrogenShell,module.exports=exports["default"];