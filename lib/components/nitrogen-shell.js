"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),_get=function(e,t,r){for(var o=!0;o;){var i=e,n=t,a=r;o=!1,null===i&&(i=Function.prototype);var s=Object.getOwnPropertyDescriptor(i,n);if(void 0!==s){if("value"in s)return s.value;var l=s.get;if(void 0===l)return;return l.call(a)}var u=Object.getPrototypeOf(i);if(null===u)return;e=u,t=n,r=a,o=!0,s=u=void 0}},_react=require("react"),_react2=_interopRequireDefault(_react),_atom=require("atom"),_storesUserStore=require("../stores/user-store"),_storesUserStore2=_interopRequireDefault(_storesUserStore),_utilPlatform=require("../util/platform"),_utilPlatform2=_interopRequireDefault(_utilPlatform),_utilIwc=require("../util/iwc"),_utilIwc2=_interopRequireDefault(_utilIwc),_path=require("path"),_path2=_interopRequireDefault(_path),_child_process=require("child_process"),_child_process2=_interopRequireDefault(_child_process),_ajax=require("../ajax"),_config=require("../config"),_config2=_interopRequireDefault(_config),_remote=require("remote"),_remote2=_interopRequireDefault(_remote),clipboard=_remote2["default"].require("clipboard"),NitrogenShell=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this.displayName="NitrogenShell",this._iframeLoaded=!1,this._proc=null,this._subscriptions=null,this.state={sshUrl:null,username:_storesUserStore2["default"].username},this.userStoreDidChange=function(){e.setState({username:_storesUserStore2["default"].username},function(){e.initializeTerm()})},this.iframeDidLoad=function(){e._iframeLoaded=!0,e.initializeTerm()},this.setFont=function(){var t=e.getIframeWindow();if(atom.config&&atom.config.settings&&atom.config.settings.editor){var r=atom.config.settings.editor;t.termSetFont(r.fontFamily,r.fontSize,r.lineHeight)}},this.killProc=function(){var t=e._proc;t&&t.kill("SIGTERM")}}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=this;_storesUserStore2["default"].onChange(this.userStoreDidChange),this.refs.iframe.addEventListener("load",this.iframeDidLoad,!1),this.fetchSSHUrl(this.props.containerSlug),this._subscriptions=new _atom.CompositeDisposable,this._subscriptions.add(atom.config.onDidChange("editor.fontFamily",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.fontSize",this.setFont)),this._subscriptions.add(atom.config.onDidChange("editor.lineHeight",this.setFont)),process.setMaxListeners(200),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.on(t,e.killProc)})}},{key:"componentWillReceiveProps",value:function(e){e.containerSlug!==this.props.containerSlug&&this.fetchSSHUrl(e.containerSlug)}},{key:"componentWillUnmount",value:function(){var e=this;_storesUserStore2["default"].offChange(this.userStoreDidChange),this.refs.iframe.removeEventListener("load",this.iframeDidLoad,!1),this.teardown(),this._subscriptions.dispose(),["exit","SIGINT","SIGHUP","SIGTERM"].forEach(function(t){process.removeListener(t,e.killProc)})}},{key:"fetchSSHUrl",value:function(e){var t=this;e&&(0,_ajax.authedAjax)({type:"GET",url:"/api/v0/containers/"+e,dataType:"json"}).then(function(e){t.setState({sshUrl:e.container.ssh_url},function(){t.initializeTerm()})},function(){})}},{key:"initializeTerm",value:function(){var e=this,t=this.state,r=t.sshUrl,o=t.username;if(r&&o&&this._iframeLoaded){var i=this.getIframeWindow();this.setFont(),i.termStart();var n=this._proc;if(!n){var a=_path2["default"].join(__dirname,"..","..","nsync");if(_utilPlatform2["default"].isMac)a=_path2["default"].join(a,"osx64","nsync-ssh");else if(_utilPlatform2["default"].isWindows)a=_path2["default"].join(a,"win32","nsync-ssh.exe");else{if(!_utilPlatform2["default"].isLinux)throw new Error("unsupported platform");a=_path2["default"].join(a,"lin64","nsync-ssh")}var s=r.match(/\/\/([^@]+)@([^:]+):(\d+)$/),l=s[1],u=s[2],c=s[3],f=i.termGetSize(),m=["-l",l,"-p",c,u,"-i",_path2["default"].join(_config2["default"].nitrousFolderPath,"SSH Keys",o,"id_rsa").replace(/ /g,Array(6).join(_path2["default"].sep)),"-z","$SHELL","-l"],p={name:"xterm-256color",cols:f.columns||80,rows:f.lines||25,cwd:_path2["default"].dirname(a),env:Object.assign({},_utilIwc2["default"].getEnv(),{TERM:"xterm-256color"})};n=this._proc=_child_process2["default"].spawn(a,m,p),n.on("close",function(){var t=e.getIframeWindow();t&&t.termWrite("[Session closed]")}),n.stdout.on("data",function(t){var r=e.getIframeWindow();r&&r.termWrite(t.toString())}),n.stderr.on("data",function(t){var r=e.getIframeWindow();r&&r.termWrite(t.toString())})}i.onTermResize=function(t,r){var o=e._proc;o&&o.stdin.write("[8;"+r+";"+t+"t")},i.onTermInput=function(t){var r=e._proc;r&&r.stdin.write(t)},i.onTermTitle=function(t){var r=e.props.onTitleChange;"function"==typeof r&&r(t)},i.onTermPrevTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-previous-item")},i.onTermNextTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"pane:show-next-item")},i.onTermCloseTab=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"tabs:close-tab")},i.onTermCloseWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"window:close")},i.onTermNewWindow=function(){atom.commands.dispatch(atom.views.getView(atom.workspace.getActivePane()),"application:new-window")},i.onTermCopy=function(e){clipboard.writeText(e)},i.onTermPaste=function(){return clipboard.readText()},i.termSizeToFit()}}},{key:"getIframeWindow",value:function(){return this.refs.iframe&&this.refs.iframe.contentWindow}},{key:"focusShell",value:function(){var e=this.getIframeWindow();e&&e.focus()}},{key:"teardown",value:function(){var e=this.getIframeWindow();e&&(e.onTermInput=null,e.onTermResize=null,e.onTermTitle=null,e.onTermPrevTab=null,e.onTermNextTab=null,e.onTermCloseTab=null,e.onTermCloseWindow=null,e.onTermNewWindow=null,e.onTermCopy=null,e.onTermPaste=null);var t=this._proc;t&&t.connected&&t.send({event:"pty.quit"}),this._proc=null}},{key:"render",value:function(){return _react2["default"].createElement("div",{className:"nitrogen-shell-component"},_react2["default"].createElement("iframe",{src:"atom://nitrogen/lib/shell/shell.html",ref:"iframe"}))}}],[{key:"propTypes",value:{containerSlug:_react.PropTypes.string,onTitleChange:_react.PropTypes.func},enumerable:!0}]),t}(_react2["default"].Component);exports["default"]=NitrogenShell,module.exports=exports["default"];