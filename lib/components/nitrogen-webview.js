"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_get=function(e,t,n){for(var i=!0;i;){var a=e,l=t,r=n;i=!1,null===a&&(a=Function.prototype);var o=Object.getOwnPropertyDescriptor(a,l);if(void 0!==o){if("value"in o)return o.value;var s=o.get;if(void 0===s)return;return s.call(r)}var c=Object.getPrototypeOf(a);if(null===c)return;e=c,t=l,n=r,i=!0,o=c=void 0}},_react=require("react"),_react2=_interopRequireDefault(_react),_atom=require("atom"),_textField=require("./text-field"),_textField2=_interopRequireDefault(_textField),_shell=require("shell"),_shell2=_interopRequireDefault(_shell),_emitter=require("../emitter"),_emitter2=_interopRequireDefault(_emitter),_url=require("url"),_url2=_interopRequireDefault(_url),_nitrogenLoading=require("./nitrogen-loading"),_nitrogenLoading2=_interopRequireDefault(_nitrogenLoading),NitrogenWebview=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this.displayName="NitrogenWebview",this._subscriptions=null,this.state={loading:!1,canGoBack:!1,canGoForward:!1},this.handleDidStartLoading=function(){e.setState({loading:!0})},this.handleDidStopLoading=function(){var t=e.refs.webview;e.setTitle(t.getTitle()),e.setState({loading:!1,canGoBack:t.canGoBack(),canGoForward:t.canGoForward()})},this.handlePageTitleSet=function(t){e.setTitle(t.title)},this.handleClickBack=function(){e.refs.webview.goBack()},this.handleClickForward=function(){e.refs.webview.goForward()},this.handleClickStop=function(){e.refs.webview.stop()},this.handleClickReload=function(t){var n=e.refs.webview;t.altKey?n.reloadIgnoringCache():n.reload()},this.handleClickOpenExternally=function(){_shell2["default"].openExternal(e.refs.webview.getUrl())},this.handleClickOpenDevTools=function(){e.refs.webview.openDevTools()},this.handleLoadCommit=function(t){t.isMainFrame&&e.refs.urlField.setValue(t.url)},this.handleNewWindow=function(e){_emitter2["default"].emit("show-webview",e.url)},this.handleTextFieldFocus=function(){e.refs.urlField.select()},this.handleTextFieldBlur=function(){e.refs.urlField.unselect()},this.handleTextFieldKeyDown=function(t){var n=e.refs.urlField;if(13===t.keyCode){n.unselect(),n.blur();var i=n.getValue(),a=_url2["default"].parse(i);a.protocol&&a.slashes||(i="http://"+i),e.loadUrl(i)}}}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){this._subscriptions=new _atom.CompositeDisposable;var e=this.refs,t=e.webview,n=e.urlField,i=this.props.url;i&&(n.setValue(i),this.loadUrl(i)),t.addEventListener("did-start-loading",this.handleDidStartLoading,!1),t.addEventListener("did-stop-loading",this.handleDidStopLoading,!1),t.addEventListener("page-title-set",this.handlePageTitleSet,!1),t.addEventListener("new-window",this.handleNewWindow,!1),t.addEventListener("load-commit",this.handleLoadCommit,!1)}},{key:"componentWillReceiveProps",value:function(e){var t=e.url;t&&t!==this.props.url&&(this.refs.urlField.setValue(t),this.loadUrl(t))}},{key:"componentWillUnmount",value:function(){this._subscriptions.dispose();var e=this.refs.webview;e.removeEventListener("did-start-loading",this.handleDidStartLoading,!1),e.removeEventListener("did-stop-loading",this.handleDidStopLoading,!1),e.removeEventListener("page-title-set",this.handlePageTitleSet,!1),e.removeEventListener("new-window",this.handleNewWindow,!1),e.removeEventListener("load-commit",this.handleLoadCommit,!1)}},{key:"loadUrl",value:function(e){this.refs.webview.src=e||"about:blank"}},{key:"setTitle",value:function(e){var t=this.props.onTitleChange;"function"==typeof t&&t(e)}},{key:"render",value:function(){var e=this.state,t=e.loading,n=e.canGoBack,i=e.canGoForward;return _react2["default"].createElement("div",{className:"nitrogen-webview-component"},_react2["default"].createElement("div",{className:"nitrogen-webview-toolbar"},_react2["default"].createElement("div",{className:"btn-group"},_react2["default"].createElement("button",{className:"btn btn-default icon icon-arrow-left",title:"Go Back",onClick:this.handleClickBack,disabled:!n}),_react2["default"].createElement("button",{className:"btn btn-default icon icon-arrow-right",title:"Go Forward",onClick:this.handleClickForward,disabled:!i})),t?_react2["default"].createElement("button",{className:"btn btn-default icon icon-x",title:"Stop navigation",onClick:this.handleClickStop}):_react2["default"].createElement("button",{className:"btn btn-default icon icon-sync",title:"Reload this page",onClick:this.handleClickReload}),_react2["default"].createElement(_textField2["default"],{ref:"urlField",onFocus:this.handleTextFieldFocus,onBlur:this.handleTextFieldBlur,onKeyDown:this.handleTextFieldKeyDown}),t?_react2["default"].createElement(_nitrogenLoading2["default"],null):"",_react2["default"].createElement("button",{className:"btn btn-default icon icon-link-external",title:"Open in external browser...",onClick:this.handleClickOpenExternally}),_react2["default"].createElement("button",{className:"btn btn-default icon icon-tools",title:"Open Developer Tools...",onClick:this.handleClickOpenDevTools})),_react2["default"].createElement("div",{className:"nitrogen-webview"},_react2["default"].createElement("webview",{ref:"webview",allowpopups:!0})))}}],[{key:"propTypes",value:{url:_react.PropTypes.string,onTitleChange:_react.PropTypes.func},enumerable:!0}]),t}(_react2["default"].Component);exports["default"]=NitrogenWebview,module.exports=exports["default"];