"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_get=function(e,t,n){for(var a=!0;a;){var r=e,s=t,i=n;a=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,s);if(void 0!==o){if("value"in o)return o.value;var c=o.get;if(void 0===c)return;return c.call(i)}var u=Object.getPrototypeOf(r);if(null===u)return;e=u,t=s,n=i,a=!0,o=u=void 0}},_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_ajax=require("../ajax"),_textField=require("./text-field"),_textField2=_interopRequireDefault(_textField),_textArea=require("./text-area"),_textArea2=_interopRequireDefault(_textArea),_emitter=require("../emitter"),_emitter2=_interopRequireDefault(_emitter),_actionsSnackbarActions=require("../actions/snackbar-actions"),_actionsSnackbarActions2=_interopRequireDefault(_actionsSnackbarActions),_storesNsyncStore=require("../stores/nsync-store"),_storesNsyncStore2=_interopRequireDefault(_storesNsyncStore),_utilIwc=require("../util/iwc"),_utilIwc2=_interopRequireDefault(_utilIwc),NitrogenFeedback=function(e){function t(){var e=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).apply(this,arguments),this.displayName="NitrogenFeedback",this.state={submitting:!1,messagePrefix:""},this.handleClickSendFeedback=function(){var t=e.refs,n=t.subjectField,a=t.messageField,r=n.getValue(),s=a.getValue();r&&s&&(e.state.submitting||(e.setState({submitting:!0}),_storesNsyncStore2["default"].running?_utilIwc2["default"].send("nsync.fetch-version"):_utilIwc2["default"].once("nsync-runner.server-running",function(){_utilIwc2["default"].send("nsync.fetch-version")})))},this.sendFeedback=function(){var t=e.refs,n=t.subjectField,a=t.messageField,r=n.getValue(),s=a.getValue();r&&s&&(0,_ajax.authedAjax)({type:"POST",url:"/api/v0/feedback",dataType:"json",data:{subject:r,body:e.state.messagePrefix+s,userAgent:navigator.userAgent,platform:navigator.platform}}).then(function(){var t=e.refs,n=t.subjectField,a=t.messageField;n.setValue(""),a.setValue(""),e.setState({submitting:!1}),_emitter2["default"].emit("hide-feedback-dialog"),_actionsSnackbarActions2["default"].post("Thank you for your feedback.")},function(){e.setState({submitting:!1}),_actionsSnackbarActions2["default"].post("Failed to submit your feedback. Please try again")})},this.handleKeyDown=function(t){var n=e.refs,a=n.subjectField,r=n.messageField,s=n.feedbackSubmitBtn,i=null,o=null;t.target===_reactDom2["default"].findDOMNode(a)?(o=s,i=r):t.target===_reactDom2["default"].findDOMNode(r)&&(o=a,i=s),o&&i&&9===t.keyCode&&process.nextTick(function(){t.shiftKey?o.focus():i.focus()})},this.nsyncStoreDidChange=function(){e.setState({messagePrefix:e.buildMessagePrefix()}),e.state.submitting&&_storesNsyncStore2["default"].nsyncVersion&&_storesNsyncStore2["default"].nsyncSSHVersion&&e.sendFeedback()}}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){_storesNsyncStore2["default"].onChange(this.nsyncStoreDidChange)}},{key:"componentWillUnmount",value:function(){_storesNsyncStore2["default"].offChange(this.nsyncStoreDidChange)}},{key:"focusTitle",value:function(){var e=this.refs.subjectField;window.setTimeout(function(){e.select(),e.focus()},10)}},{key:"buildMessagePrefix",value:function(){var e="[Environment]\n",t=atom.packages.loadedPackages,n=[],a=null;for(var r in t){var s=t[r];"nitrogen"!==s.name.toLowerCase()?s.bundledPackage||n.push(s):a=s}return e+="Nitrogen: "+a.metadata.version+"\n",n.forEach(function(t){e+=t.name+": "+t.metadata.version+"\n"}),_storesNsyncStore2["default"].nsyncVersion&&(e+="Nsync: "+_storesNsyncStore2["default"].nsyncVersion+"\n"),_storesNsyncStore2["default"].nsyncSSHVersion&&(e+="Nsync SSH: "+_storesNsyncStore2["default"].nsyncSSHVersion+"\n"),e+="\n[Message]\n"}},{key:"render",value:function(){var e=this.state.submitting,t=e?"Sending...":"Send Feedback";return _react2["default"].createElement("div",{className:"nitrogen-feedback-component"},_react2["default"].createElement("h2",{className:"icon icon-issue-opened"},"Nitrogen Feedback"),_react2["default"].createElement(_textField2["default"],{ref:"subjectField",className:"subject-field",placeholder:"Subject",onKeyDown:this.handleKeyDown}),_react2["default"].createElement(_textArea2["default"],{ref:"messageField",className:"message-field",placeholder:"Message",onKeyDown:this.handleKeyDown}),_react2["default"].createElement("div",{className:"btn-wrap-group"},_react2["default"].createElement("button",{ref:"feedbackSubmitBtn",className:"btn btn-primary btn-block",onClick:this.handleClickSendFeedback,disabled:e},t)))}}]),t}(_react2["default"].Component);exports["default"]=NitrogenFeedback,module.exports=exports["default"];